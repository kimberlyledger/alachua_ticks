---
title: "landcover_PCA"
author: "Kimberly Ledger"
date: "3/3/2022"
output: html_document
---

this code will plot PCA's using landcover proportion at multiple buffer scales around potential tick collection sites in Alachua County, Florida 


load libraries 
```{r, message=FALSE}
library(tidyverse)
library(ggplot2)
library(ggbiplot)
```


read in the data
```{r}
lc <- read.csv("AlCo_landcover_allscales_sort.csv")
head(lc)
```

this is the landcover classification

*  1 = Agriculture 
*  2 = Commercial
*  3 = Forest
*  4 = Lawn 
*  5 = Residential
*  6 = Water
*  7 = Wetland

sampling site selection was based on PC1 using land cover proportions using a 1km buffer around all potential sites 

filter data to only include land cover at 1km 
```{r}
lc_1km <- lc[,c(26:32)]
head(lc_1km)
```

log transform and apply z-score standardization to the data 
```{r}
lc_1km_log <- log1p(lc_1km)   
z_lc <- lc_1km_log
```

update column names 
```{r}
colnames(z_lc) <- c("agriculture", "commercial", "forest", "lawn", "residential", "water", "wetland")
```

run a PCA using the function princomp from the stats package
```{r}
lc_pca <- princomp(z_lc, cor=F)
#cor=F, because we are using the covariance matrix instead of the correlation matrix 

summary(lc_pca)

#get factor loadings for each PC
loadings(lc_pca)

# get factor scores for each site 
lc_pca$scores

#access using a scree plot 
plot(lc_pca, type="lines")
```

plot the first two axes of the PCA - landcovers
```{r}
plot(lc_pca$loadings,type="n",xlab="PC 1", ylab="PC 2")
text(lc_pca$loadings, labels=as.character(colnames(z_lc)), pos=1, cex=1)
```

plot the first two axes of the PCA - sites
```{r}
plot(lc_pca$scores,type="n",xlab="PC 1", ylab="PC 2")
text(lc_pca$scores, labels=as.character(rownames(z_lc)), pos=1, cex=1)
```

biplot 
```{r}
biplot(lc_pca$scores,lc_pca$loading,xlab="PC 1", ylab="PC 2",ylim=c(-0.2,0.4), xlim=c(-0.4,0.5))
```

biplot - replace site numbers with '*'
```{r}
biplot(lc_pca$scores,lc_pca$loading,xlabs= rep("*",52), xlab="PC 1", ylab="PC 2",ylim=c(-0.2,0.4), xlim=c(-0.4,0.5))

```

make a nicer plot using ggplot 

start by reformating the pca dataframe to have information on site
```{r}
df_out <- as.data.frame(lc_pca$scores)
df_out$group <- lc$Field_Type
df_out$sampled <- lc$sampled

df_out <- df_out %>%
  mutate(sampled2 = recode(sampled, "N" = 0.5, "Y"=1))

#df_out$sampled2 <- as.factor(df_out$sampled2)
```

```{r}
# Extract loadings of the variables
var <- rownames(lc_pca$loadings)
load <- loadings(lc_pca)[]
PCAloadings <- data.frame(Variables = var, c1 = load[,1], c2 = load[,2])


ggplot(df_out, aes(x=Comp.1, y =Comp.2, color=group))+ 
  geom_segment(data = PCAloadings, aes(x=0 , y =0, xend = c1*0.3, yend = c2*0.3),
               arrow = arrow(length = unit(1/2, "picas")), color = "black") + 
  geom_point(aes(alpha = sampled), position = position_jitter(h=0.01,w=0.01)) + 
  scale_alpha_discrete(range = c(0.4,1)) +
  annotate("text", x = (PCAloadings$c1*0.3), y = (PCAloadings$c2*0.3),
     label = PCAloadings$Variables) +
  theme_classic()
```

now try ggbiplot 

```{r}
#lc.groups <- lc$Field_Type
#lc.samp <- lc$sampled

lc <- lc %>%
  unite("GS", Field_Type, sampled, sep = "/", remove = F)

unique(lc$GS)
lc.newgroups <- as.factor(lc$GS)
lc.new <- factor(lc.newgroups, levels = c("Manicured/Yes", "Natural/Yes", "Manicured/No", "Natural/No"))


biplot <- ggbiplot(lc_pca, groups = lc.new) +
  scale_color_manual(name = "Habitat Type/Sampled?", values = c("#F8766D", "#00BFC4", "#F5C9C6", "#D5F0EE")) + 
  theme_classic() + 
  xlim(c(-2,2))

biplot
```

ggsave("Figures/biplot.tiff", dpi=300, height = 6, width = 8)


the issue here is that site points are overlapping... but i rearrange sites so that all sampled sites plot on top 


okay so the negative values of PC1 have high proportions of commercial and residential 
and the positive values of PC1 have high proportions of forest (and to some extent wetland)


extract/recontstruct original values from PC1 

```{r}
mu = colMeans(z_lc)
nComp = 1

Xhat = lc_pca$scores[,1:nComp] %*% t(lc_pca$loadings[,1:nComp])
Xhat = scale(Xhat, center = -mu, scale = FALSE)

Xhat[1,]
```

now undo the log1p transformation for forest cover 
```{r}
exp(0.4751)-1
```






